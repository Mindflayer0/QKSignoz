CREATE TABLE signoz_metrics.samples_v2_json_string
(
    `metric_name` LowCardinality(String),
    `fingerprint` UInt64 CODEC(DoubleDelta, LZ4),
    `timestamp_ms` Int64 CODEC(DoubleDelta, LZ4),
    `value` Float64 CODEC(Gorilla, LZ4),
    `labels` String CODEC(ZSTD(2))
)
ENGINE = MergeTree
PARTITION BY toDate(timestamp_ms / 1000)
ORDER BY (metric_name, fingerprint, timestamp_ms)
SETTINGS index_granularity = 8192


INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms, value, labels FROM samples_v2 INNER JOIN time_series_v2 USING fingerprint;



SELECT
    ts,
    sum(runningDifference(res) / runningDifference(ts)) AS res,
    instance
FROM
(
    SELECT
        instance,
        toStartOfInterval(toDateTime(intDiv(timestamp_ms, 1000)), toIntervalSecond(60)) AS ts,
        max(value) AS res
    FROM signoz_metrics.samples_v2
    WHERE metric_name = 'node_cpu_seconds_total'
    GROUP BY
        instance, ts
    ORDER BY
        instance, ts
)
    GROUP BY
        instance, ts
    ORDER BY
        instance, ts


16937 rows in set. Elapsed: 3.263 sec. Processed 451.04 million rows, 12.01 GB (138.23 million rows/s., 3.68 GB/s.)



CREATE TABLE signoz_metrics.samples_v2_json_string_ngram_idx
(
    `metric_name` LowCardinality(String),
    `fingerprint` UInt64 CODEC(DoubleDelta, LZ4),
    `timestamp_ms` Int64 CODEC(DoubleDelta, LZ4),
    `value` Float64 CODEC(Gorilla, LZ4),
    `labels` String CODEC(ZSTD(2)),
    INDEX idx_labels labels TYPE ngrambf_v1(4, 1024, 2, 0) GRANULARITY 1
)
ENGINE = MergeTree
PARTITION BY toDate(timestamp_ms / 1000)
ORDER BY (metric_name, fingerprint, timestamp_ms)
SETTINGS index_granularity = 8192

INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 2 * 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 3 * 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 4 * 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 5 * 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 6 * 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 7 * 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 8 * 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 9 * 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 10 * 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;
INSERT INTO signoz_metrics.samples_v2_json_string SELECT metric_name, fingerprint, timestamp_ms - 60000, value, labels FROM signoz_metrics.samples_v2_json_string_copy;



SELECT
    ts,
    sum(runningDifference(res) / runningDifference(ts)) AS res,
    instance
FROM
(
    SELECT
        toStartOfInterval(toDateTime(intDiv(timestamp_ms, 1000)), toIntervalSecond(900)) AS ts,
        max(value) AS res,
        JSONExtractString(labels, 'series_id') as instance,
        JSONExtractString(labels, 'label_key_kkkkk_3') as label_key_kkkkk_3
    FROM signoz_metrics.samples_v2_json_string
    WHERE metric_name = 'avalanche_metric_mmmmm_0_0' AND JSONExtractString(labels, 'series_id') LIKE '1%'
    GROUP BY
        instance, label_key_kkkkk_3, ts
)
    GROUP BY
        instance, label_key_kkkkk_3, ts
settings min_bytes_to_use_direct_io=1;

3334441 rows in set. Elapsed: 19.648 sec. Processed 613.31 million rows, 568.65 GB (31.21 million rows/s., 28.94 GB/s.)



SELECT
    ts,
    sum(runningDifference(res) / runningDifference(ts)) AS res,
    instance
FROM
(
    SELECT
        toStartOfInterval(toDateTime(intDiv(timestamp_ms, 1000)), toIntervalSecond(900)) AS ts,
        max(value) AS res,
        JSONExtractString(labels, 'series_id') as instance,
        JSONExtractString(labels, 'label_key_kkkkk_3') as label_key_kkkkk_3
    FROM signoz_metrics.samples_v2_json_string_ngram_idx
    WHERE metric_name = 'avalanche_metric_mmmmm_0_0' AND JSONExtractString(labels, 'series_id') LIKE '1%'
    GROUP BY
        instance, label_key_kkkkk_3, ts
)
    GROUP BY
        instance, label_key_kkkkk_3, ts
settings min_bytes_to_use_direct_io=1;


SELECT
    ts,
    sum(runningDifference(res) / runningDifference(ts)) AS res,
    instance
FROM
(
    SELECT
        toStartOfInterval(toDateTime(intDiv(timestamp_ms, 1000)), toIntervalSecond(900)) AS ts,
        max(value) AS res,
        labels_values[indexOf(labels_keys, 'series_id')] as instance,
        labels_values[indexOf(labels_keys, 'label_key_kkkkk_3')] as label_key_kkkkk_3
    FROM signoz_metrics.samples_v2_labels_keys_and_values_normal_string
    WHERE metric_name = 'avalanche_metric_mmmmm_0_0' AND labels_values[indexOf(labels_keys, 'series_id')] LIKE '1%'
    GROUP BY
        instance, label_key_kkkkk_3, ts
)
    GROUP BY
        instance, label_key_kkkkk_3, ts
settings min_bytes_to_use_direct_io=1;

3334441 rows in set. Elapsed: 18.566 sec. Processed 613.33 million rows, 738.90 GB (33.03 million rows/s., 39.80 GB/s.)

SELECT
    ts,
    sum(runningDifference(res) / runningDifference(ts)) AS res,
    instance
FROM
(
    SELECT
        toStartOfInterval(toDateTime(intDiv(timestamp_ms, 1000)), toIntervalSecond(900)) AS ts,
        max(value) AS res,
        labels_values[indexOf(labels_keys, 'series_id')] as instance,
        labels_values[indexOf(labels_keys, 'label_key_kkkkk_3')] as label_key_kkkkk_3
    FROM signoz_metrics.samples_v2_labels_keys_and_values_lc
    WHERE metric_name = 'avalanche_metric_mmmmm_0_0' AND labels_values[indexOf(labels_keys, 'series_id')] LIKE '1%'
    GROUP BY
        instance, label_key_kkkkk_3, ts
)
    GROUP BY
        instance, label_key_kkkkk_3, ts
settings min_bytes_to_use_direct_io=1;

3334441 rows in set. Elapsed: 11.412 sec. Processed 613.32 million rows, 71.27 GB (53.74 million rows/s., 6.25 GB/s.)


SELECT
    ts,
    sum(runningDifference(res) / runningDifference(ts)) AS res,
    instance
FROM
(
    SELECT
        toStartOfInterval(toDateTime(intDiv(timestamp_ms, 1000)), toIntervalSecond(900)) AS ts,
        max(value) AS res,
        labels['series_id'] as instance,
        labels['label_key_kkkkk_3'] as label_key_kkkkk_3
    FROM signoz_metrics.samples_v2_labels_map_normal_string
    WHERE metric_name = 'avalanche_metric_mmmmm_0_0' AND labels['series_id'] LIKE '1%'
    GROUP BY
        instance, label_key_kkkkk_3, ts
)
    GROUP BY
        instance, label_key_kkkkk_3, ts
settings min_bytes_to_use_direct_io=1;

3334441 rows in set. Elapsed: 21.424 sec. Processed 616.39 million rows, 737.79 GB (28.77 million rows/s., 34.44 GB/s.)



SELECT
    ts,
    sum(runningDifference(res) / runningDifference(ts)) AS res,
    instance
FROM
(
    SELECT
        toStartOfInterval(toDateTime(intDiv(timestamp_ms, 1000)), toIntervalSecond(900)) AS ts,
        max(value) AS res,
        labels['series_id'] as instance,
        labels['label_key_kkkkk_3'] as label_key_kkkkk_3
    FROM signoz_metrics.samples_v2_labels_map_normal_string
    WHERE metric_name = 'avalanche_metric_mmmmm_0_0' AND labels['series_id'] LIKE '1%'
    GROUP BY
        instance, label_key_kkkkk_3, ts
)
    GROUP BY
        instance, label_key_kkkkk_3, ts
settings min_bytes_to_use_direct_io=1;

3334441 rows in set. Elapsed: 21.424 sec. Processed 616.39 million rows, 737.79 GB (28.77 million rows/s., 34.44 GB/s.)



SELECT
    ts,
    sum(runningDifference(res) / runningDifference(ts)) AS res,
    instance
FROM
(
    SELECT
        toStartOfInterval(toDateTime(intDiv(timestamp_ms, 1000)), toIntervalSecond(900)) AS ts,
        max(value) AS res,
        instance,
        label_key_kkkkk_3
    FROM signoz_metrics.samples_v2 INNER JOIN (SELECT fingerprint, JSONExtractString(labels, 'series_id') as instance, JSONExtractString(labels, 'label_key_kkkkk_3') as label_key_kkkkk_3 FROM time_series_v2 WHERE metric_name = 'avalanche_metric_mmmmm_0_0' AND JSONExtractString(labels, 'series_id') LIKE '1%') as filtered_time_series USING fingerprint
    GROUP BY
        instance, label_key_kkkkk_3, ts
)
    GROUP BY
        instance, label_key_kkkkk_3, ts
settings min_bytes_to_use_direct_io=1;

3223330 rows in set. Elapsed: 8.051 sec. Processed 695.88 million rows, 19.17 GB (86.43 million rows/s., 2.38 GB/s.)

CREATE TABLE signoz_metrics.samples_v2_labels_keys_and_values
(
    `metric_name` LowCardinality(String),
    `fingerprint` UInt64 CODEC(DoubleDelta, LZ4),
    `timestamp_ms` Int64 CODEC(DoubleDelta, LZ4),
    `value` Float64 CODEC(Gorilla, LZ4),
    `labels_keys` Array(LowCardinality(String)) CODEC(ZSTD(5)),
    `labels_values` Array(LowCardinality(String)) CODEC(ZSTD(5))
)
ENGINE = MergeTree
PARTITION BY toDate(timestamp_ms / 1000)
ORDER BY (metric_name, fingerprint, timestamp_ms)
SETTINGS index_granularity = 8192



CREATE TABLE signoz_metrics.samples_v2_labels_map_lc
(
    `metric_name` LowCardinality(String),
    `fingerprint` UInt64 CODEC(DoubleDelta, LZ4),
    `timestamp_ms` Int64 CODEC(DoubleDelta, LZ4),
    `value` Float64 CODEC(Gorilla, LZ4),
    `labels` Map(LowCardinality(String), LowCardinality(String)) CODEC(LZ4),
    INDEX idx_labels_keys mapKeys(labels) TYPE ngrambf_v1(4, 1024, 3, 0) GRANULARITY 1,
    INDEX idx_labels_values mapValues(labels) TYPE ngrambf_v1(4, 1024, 3, 0) GRANULARITY 1

)
ENGINE = MergeTree
PARTITION BY toDate(timestamp_ms / 1000)
ORDER BY (metric_name, fingerprint, timestamp_ms)


insert into samples_v2_labels_map_lc select metric_name, fingerprint, timestamp_ms, value, CAST((labels_keys, labels_values), 'Map(LowCardinality(String), LowCardinality(String))') as labels from signoz_metrics.samples_v2_labels_keys_and_values


CREATE TABLE signoz_metrics.samples_v2_labels_map
(
    `metric_name` LowCardinality(String),
    `fingerprint` UInt64 CODEC(DoubleDelta, LZ4),
    `timestamp_ms` Int64 CODEC(DoubleDelta, LZ4),
    `value` Float64 CODEC(Gorilla, LZ4),
    `labels` Map(String, String) CODEC(LZ4),
    INDEX idx_labels_keys mapKeys(labels) TYPE ngrambf_v1(4, 1024, 3, 0) GRANULARITY 1,
    INDEX idx_labels_values mapValues(labels) TYPE ngrambf_v1(4, 1024, 3, 0) GRANULARITY 1

)
ENGINE = MergeTree
PARTITION BY toDate(timestamp_ms / 1000)
ORDER BY (metric_name, fingerprint, timestamp_ms)

INSERT INTO signoz_metrics.samples_v2_labels_map SELECT * FROM signoz_metrics.samples_v2_labels_map_lc